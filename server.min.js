"use strict"
function checkName(e,n,i){return e.map(function(e){return e.name}).indexOf(n)>-1?checkName(e,n+"_",i):(e.push({name:n,id:i}),n)}var _utils=require("./utils"),express=require("express"),app=express(),http=require("http").Server(app),io=require("socket.io")(http),compress=require("compression"),users=[],names=[]
app.use(compress()),app.get("/",function(e,n){n.sendFile(__dirname+"/client/public/index.html"),n.flush()}),app.use(express["static"]("client/public")),io.sockets.on("connection",function(e){console.log("connected"),users.push(e),io.emit("userCount",users.length),e.on("requestUsers",function(n){var i=checkName(names,n,e.id)
e.emit("respondUsername",i),io.emit("respondUsers",names)}),e.on("challenge",function(n){var i=names[names.findIndex(function(n){return n.id===e.id})],s=names[names.findIndex(function(e){return e.name===n.challenged})]
i&&(i.inChallenge=!0),s&&(s.inChallenge=!0),n.challenger||(n.challenger={cancel:!0},i&&(i.inChallenge=void 0),s&&(s.inChallenge=void 0)),s&&io.to(s.id).emit("challenged",n.challenger),io.emit("respondUsers",names)}),e.on("meetChallenge",function(n){var i=names[names.findIndex(function(e){return e.name===n.challenger})],s=names[names.findIndex(function(e){return e.name===n.challenged})]
i&&(i.inChallenge=void 0),s&&(s.inChallenge=void 0),io.emit("respondUsers",names),i&&io.to(i.id).emit("challengeResponse",{answer:n.answer,challenged:s,challenger:i}),e.emit("challenged",!1)}),e.on("requestRoom",function(e){var n=function(n){var i=names.find(function(i){return i.name===e[n]})
i&&!function(){var n=users.find(function(e){return e.id===i.id}),s=Object.keys(n.rooms).map(function(e){return n.rooms[e]})
s.indexOf(e.challenger)<=-1&&(io.to(i.id).emit("roomResponse",e.challenger),n.join(e.challenger),setTimeout(function(){return n.emit("arrowResponse",(0,_utils.randLetter)())},2e3),names=names.filter(function(e){return e.id!==n.id}),io.emit("respondUsers",names))}()}
for(var i in e)n(i)}),e.on("requestArrow",function(n){io.to(n.room).emit("arrowResponse",(0,_utils.randLetter)()),e.broadcast.to(n.room).emit("enemyDistance",n.distance)}),e.on("requestWinner",function(e){io.to(e.room).emit("winnerResponse",e.winner)}),e.on("leaveGame",function(n){e.leave(n),io.to(n).emit("someoneLeft"),e.emit("leaveResponse")}),e.on("requestRefresh",function(){e.emit("refreshResponse")}),e.on("disconnect",function(){console.log("disconnection")
var n=users.indexOf(e)
users.splice(n,1),names=names.filter(function(n){return n.id!==e.id}),io.emit("userCount",users.length),io.emit("respondUsers",names)})}),http.listen(process.env.PORT||3e3,function(){console.log("listening on port "+(process.env.PORT||3e3))})
